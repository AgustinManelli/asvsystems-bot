// require("dotenv").config();

// /**
//  * Configuraci√≥n centralizada del bot de WhatsApp
//  */

// const config = {
//   // Configuraci√≥n de la base de datos
//   database: {
//     host: process.env.DB_HOST || "localhost",
//     port: process.env.DB_PORT || 3306,
//     user: process.env.DB_USER,
//     password: process.env.DB_PASSWORD,
//     database: process.env.DB_NAME,
//     connectionLimit: 10,
//     acquireTimeout: 60000,
//     timeout: 60000,
//     charset: "utf8mb4",
//   },

//   // Informaci√≥n de la empresa
//   empresa: {
//     nombre: process.env.COMPANY_NAME || "ASVSystems",
//     telefono: process.env.COMPANY_PHONE || "+54 351 534631",
//     email: process.env.COMPANY_EMAIL || "asvsystems@gmail.com  ",
//     direccion: process.env.COMPANY_ADDRESS || "Av. Principal 123, C√≥rdoba",
//     horario: process.env.COMPANY_HOURS || "Lunes a Viernes 9am-6pm",
//     website: process.env.WEBSITE_URL || "https://asvsystems.com.ar/app",
//     catalogoUrl:
//       process.env.CATALOG_URL || "https://asvsystems.com.ar/app/productos",
//     soporteUrl:
//       process.env.SUPPORT_URL || "https://asvsystems.com.ar/app/contacto",
//   },

//   // Configuraci√≥n del bot
//   bot: {
//     nombre: process.env.BOT_NAME || "Bot de Pedidos",
//     version: process.env.BOT_VERSION || "1.0.0",
//     qrPort: process.env.QR_PORT || 3000,
//     logLevel: process.env.LOG_LEVEL || "info",
//     logFile: process.env.LOG_FILE || "bot.log",
//   },

//   // L√≠mites y configuraciones operativas
//   limites: {
//     maxConversacionesPorUsuario:
//       parseInt(process.env.MAX_CONVERSACIONES_POR_USUARIO) || 100,
//     diasLimpiezaConversaciones:
//       parseInt(process.env.DIAS_LIMPIEZA_CONVERSACIONES) || 30,
//     maxProductosMostrar: 20,
//     maxPedidosMostrar: 10,
//     timeoutConsulta: 30000, // 30 segundos
//     maxIntentos: 3,
//   },

//   // Mensajes predeterminados
//   mensajes: {
//     bienvenida: {
//       principal: "üõçÔ∏è ¬°Hola! Bienvenido a nuestro sistema de pedidos",
//       opciones: "üîç ¬øQu√© te gustar√≠a hacer hoy?",
//       primerUso:
//         "üëã ¬°Es la primera vez que nos escribes! Te hemos registrado autom√°ticamente.",
//     },

//     errores: {
//       conexionBD: "üîß Tenemos problemas t√©cnicos. Intenta m√°s tarde.",
//       usuarioNoEncontrado:
//         "‚ùå No encontr√© tu informaci√≥n. Escribe *hola* para registrarte.",
//       pedidoNoEncontrado:
//         "‚ùå No encontr√© ese pedido o no pertenece a tu cuenta.",
//       sinPedidos: "üì¶ No tienes pedidos registrados a√∫n.",
//       formatoInvalido: "‚ö†Ô∏è Formato inv√°lido. Verifica los datos ingresados.",
//       permisosDenegados:
//         "üö´ No tienes permisos para acceder a esta informaci√≥n.",
//       errorGenerico: "‚ùå Ocurri√≥ un error inesperado. Intenta nuevamente.",
//     },

//     ayuda: {
//       comandos:
//         "üí° *Comandos √∫tiles:*\n‚Ä¢ *mis pedidos* - Ver tus pedidos\n‚Ä¢ *productos* - Ver cat√°logo\n‚Ä¢ *contacto* - Informaci√≥n de contacto\n‚Ä¢ *ayuda* - Ver esta ayuda",
//       noEntendido:
//         "‚ùì No entend√≠ tu mensaje. Escribe *ayuda* para ver los comandos disponibles.",
//     },

//     estados: {
//       buscando: "üîç Buscando informaci√≥n...",
//       procesando: "‚è≥ Procesando solicitud...",
//       consultando: "üì° Consultando base de datos...",
//       generando: "üîÑ Generando respuesta...",
//     },
//   },

//   // Configuraci√≥n de horarios de atenci√≥n
//   horarios: {
//     dias: {
//       lunes: { inicio: 9, fin: 18 },
//       martes: { inicio: 9, fin: 18 },
//       miercoles: { inicio: 9, fin: 18 },
//       jueves: { inicio: 9, fin: 18 },
//       viernes: { inicio: 9, fin: 18 },
//       sabado: { activo: false },
//       domingo: { activo: false },
//     },
//     zona: "America/Argentina/Cordoba",
//   },

//   // Configuraci√≥n de respuestas autom√°ticas
//   respuestasAuto: {
//     fuera_horario:
//       "‚è∞ Estamos fuera del horario de atenci√≥n ({horario}). Te responderemos cuando volvamos.",
//     mensaje_no_comercial:
//       "üíº Solo atendemos consultas relacionadas con pedidos durante este horario.",
//     derivacion_humano:
//       "üë®‚Äçüíº Te estoy derivando con un representante humano. Espera un momento...",
//   },

//   // Palabras clave y comandos
//   comandos: {
//     saludo: [
//       "hola",
//       "hi",
//       "hello",
//       "buenas",
//       "buenos dias",
//       "buenas tardes",
//       "buenas noches",
//       "inicio",
//       "start",
//     ],
//     pedidos: ["mis pedidos", "pedidos", "ordenes", "compras"],
//     estado: ["estado", "status", "seguimiento", "tracking"],
//     productos: ["productos", "catalogo", "art√≠culos", "items", "que venden"],
//     contacto: [
//       "contacto",
//       "tel√©fono",
//       "direcci√≥n",
//       "ubicaci√≥n",
//       "soporte",
//       "ayuda",
//     ],
//     activos: ["activos", "pendientes", "en proceso", "vigentes"],
//     ayuda: ["ayuda", "help", "comandos", "opciones", "?"],
//   },

//   // Emojis y s√≠mbolos utilizados
//   emojis: {
//     estados: {
//       pending: "‚è≥",
//       processing: "üîÑ",
//       shipped: "üöö",
//       delivered: "‚úÖ",
//       cancelled: "‚ùå",
//       refunded: "üí∏",
//     },
//     acciones: {
//       buscar: "üîç",
//       cargar: "‚è≥",
//       exito: "‚úÖ",
//       error: "‚ùå",
//       info: "‚ÑπÔ∏è",
//       atencion: "‚ö†Ô∏è",
//       dinero: "üí∞",
//       productos: "üõçÔ∏è",
//       usuario: "üë§",
//       fecha: "üìÖ",
//       telefono: "üìû",
//       email: "üìß",
//       direccion: "üìç",
//       entrega: "üöö",
//       pago: "üí≥",
//     },
//   },

//   // Validaciones
//   validaciones: {
//     telefono: /^\+?54\d{10}$/,
//     email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
//     numeroPedido: /^\d+$/,
//     codigoProducto: /^[A-Za-z0-9\-_]+$/,
//   },

//   // URLs de webhooks y APIs externas (si las hay)
//   apis: {
//     // Aqu√≠ podr√≠as agregar configuraci√≥n para APIs de pago, env√≠o, etc.
//     mercadopago: {
//       accessToken: process.env.MP_ACCESS_TOKEN,
//       sandbox: process.env.MP_SANDBOX === "true",
//     },
//   },
// };

// /**
//  * Obtener configuraci√≥n de la empresa
//  * @returns {Object} Informaci√≥n de la empresa
//  */
// config.obtenerInfoEmpresa = function () {
//   return {
//     nombre: this.empresa.nombre,
//     contacto: `üìû ${this.empresa.telefono}\nüìß ${this.empresa.email}\nüìç ${this.empresa.direccion}\nüïê ${this.empresa.horario}`,
//   };
// };

// /**
//  * Verificar si estamos en horario de atenci√≥n
//  * @returns {boolean} True si estamos en horario
//  */
// config.enHorarioAtencion = function () {
//   const ahora = new Date();
//   const dia = ahora.toLocaleLowerCase("es").split(" ")[0]; // lunes, martes, etc.
//   const hora = ahora.getHours();

//   const configDia = this.horarios.dias[dia];

//   if (!configDia || configDia.activo === false) {
//     return false;
//   }

//   return hora >= configDia.inicio && hora < configDia.fin;
// };

// /**
//  * Obtener mensaje de horario
//  * @returns {string} Mensaje sobre el horario
//  */
// config.obtenerMensajeHorario = function () {
//   if (this.enHorarioAtencion()) {
//     return "‚úÖ Estamos disponibles ahora";
//   }

//   return this.respuestasAuto.fuera_horario.replace(
//     "{horario}",
//     this.empresa.horario
//   );
// };

// /**
//  * Validar comando
//  * @param {string} mensaje - Mensaje del usuario
//  * @returns {string|null} Tipo de comando identificado
//  */
// config.identificarComando = function (mensaje) {
//   const textoLimpio = mensaje.toLowerCase().trim();

//   for (const [tipo, palabrasClave] of Object.entries(this.comandos)) {
//     if (palabrasClave.some((palabra) => textoLimpio.includes(palabra))) {
//       return tipo;
//     }
//   }

//   // Verificar si es un n√∫mero de pedido
//   if (this.validaciones.numeroPedido.test(textoLimpio)) {
//     return "numero_pedido";
//   }

//   return null;
// };

// /**
//  * Obtener emoji para estado
//  * @param {string} estado - Estado del pedido
//  * @returns {string} Emoji correspondiente
//  */
// config.obtenerEmojiEstado = function (estado) {
//   return this.emojis.estados[estado] || "üìã";
// };

// module.exports = config;

require("dotenv").config();

/**
 * Configuraci√≥n centralizada del bot de WhatsApp adaptada para Heroku
 */

const config = {
  // Configuraci√≥n de la base de datos - Adaptado para Heroku
  database: {
    host: process.env.DB_HOST || "localhost",
    port: process.env.DB_PORT || 3306,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    connectionLimit: parseInt(process.env.DB_CONNECTION_LIMIT) || 5, // Reducido para Heroku
    acquireTimeout: 60000,
    timeout: 60000,
    charset: "utf8mb4",
    // Configuraciones adicionales para Heroku
    ssl:
      process.env.DB_SSL === "true"
        ? {
            rejectUnauthorized: false, // Para bases de datos en la nube
          }
        : false,
    reconnect: true,
    idleTimeout: 300000, // 5 minutos
    connectTimeout: 60000,
  },

  // Informaci√≥n de la empresa
  empresa: {
    nombre: process.env.COMPANY_NAME || "ASVSystems",
    telefono: process.env.COMPANY_PHONE || "+54 351 534631",
    email: process.env.COMPANY_EMAIL || "asvsystems@gmail.com",
    direccion: process.env.COMPANY_ADDRESS || "Av. Principal 123, C√≥rdoba",
    horario: process.env.COMPANY_HOURS || "Lunes a Viernes 9am-6pm",
    website: process.env.WEBSITE_URL || "https://asvsystems.com.ar/app",
    catalogoUrl:
      process.env.CATALOG_URL || "https://asvsystems.com.ar/app/productos",
    soporteUrl:
      process.env.SUPPORT_URL || "https://asvsystems.com.ar/app/contacto",
  },

  // Configuraci√≥n del bot - Adaptado para Heroku
  bot: {
    nombre: process.env.BOT_NAME || "Bot de Pedidos",
    version: process.env.BOT_VERSION || "1.0.0",
    qrPort: 3001, // Usar el puerto de Heroku
    logLevel: process.env.LOG_LEVEL || "info",
    logFile: process.env.LOG_FILE || "bot.log",
    // Configuraci√≥n espec√≠fica para Heroku
    isProduction: process.env.NODE_ENV === "production",
    herokuAppName: process.env.HEROKU_APP_NAME || "whatsapp-bot-pedidos",
    keepAliveUrl: process.env.KEEP_ALIVE_URL, // URL para mantener la app activa
  },

  // L√≠mites y configuraciones operativas - Optimizado para Heroku
  limites: {
    maxConversacionesPorUsuario:
      parseInt(process.env.MAX_CONVERSACIONES_POR_USUARIO) || 50, // Reducido para Heroku
    diasLimpiezaConversaciones:
      parseInt(process.env.DIAS_LIMPIEZA_CONVERSACIONES) || 15, // M√°s frecuente
    maxProductosMostrar: 15, // Reducido para optimizar memoria
    maxPedidosMostrar: 8, // Reducido para optimizar memoria
    timeoutConsulta: 20000, // 20 segundos (reducido)
    maxIntentos: 2, // Reducido para Heroku
    // L√≠mites espec√≠ficos para Heroku
    maxMemoryUsage: 512, // MB
    maxConcurrentConnections: 10,
  },

  // Mensajes predeterminados
  mensajes: {
    bienvenida: {
      principal: "üõçÔ∏è ¬°Hola! Bienvenido a nuestro sistema de pedidos",
      opciones: "üîç ¬øQu√© te gustar√≠a hacer hoy?",
      primerUso:
        "üëã ¬°Es la primera vez que nos escribes! Te hemos registrado autom√°ticamente.",
    },

    errores: {
      conexionBD: "üîß Tenemos problemas t√©cnicos. Intenta m√°s tarde.",
      usuarioNoEncontrado:
        "‚ùå No encontr√© tu informaci√≥n. Escribe *hola* para registrarte.",
      pedidoNoEncontrado:
        "‚ùå No encontr√© ese pedido o no pertenece a tu cuenta.",
      sinPedidos: "üì¶ No tienes pedidos registrados a√∫n.",
      formatoInvalido: "‚ö†Ô∏è Formato inv√°lido. Verifica los datos ingresados.",
      permisosDenegados:
        "üö´ No tienes permisos para acceder a esta informaci√≥n.",
      errorGenerico: "‚ùå Ocurri√≥ un error inesperado. Intenta nuevamente.",
      // Errores espec√≠ficos de Heroku
      servicioTemporalmenteNoDisponible:
        "‚ö†Ô∏è Servicio temporalmente no disponible. Reintentando...",
      limitesExcedidos:
        "‚è∞ L√≠mites de uso temporalmente excedidos. Espera un momento.",
    },

    ayuda: {
      comandos:
        "üí° *Comandos √∫tiles:*\n‚Ä¢ *mis pedidos* - Ver tus pedidos\n‚Ä¢ *productos* - Ver cat√°logo\n‚Ä¢ *contacto* - Informaci√≥n de contacto\n‚Ä¢ *ayuda* - Ver esta ayuda",
      noEntendido:
        "‚ùì No entend√≠ tu mensaje. Escribe *ayuda* para ver los comandos disponibles.",
    },

    estados: {
      buscando: "üîç Buscando informaci√≥n...",
      procesando: "‚è≥ Procesando solicitud...",
      consultando: "üì° Consultando base de datos...",
      generando: "üîÑ Generando respuesta...",
      reconectando: "üîÑ Reconectando servicio...", // Nuevo para Heroku
    },
  },

  // Configuraci√≥n de horarios de atenci√≥n
  horarios: {
    dias: {
      lunes: { inicio: 9, fin: 18 },
      martes: { inicio: 9, fin: 18 },
      miercoles: { inicio: 9, fin: 18 },
      jueves: { inicio: 9, fin: 18 },
      viernes: { inicio: 9, fin: 18 },
      sabado: { activo: false },
      domingo: { activo: false },
    },
    zona: "America/Argentina/Cordoba",
  },

  // Configuraci√≥n de respuestas autom√°ticas
  respuestasAuto: {
    fuera_horario:
      "‚è∞ Estamos fuera del horario de atenci√≥n ({horario}). Te responderemos cuando volvamos.",
    mensaje_no_comercial:
      "üíº Solo atendemos consultas relacionadas con pedidos durante este horario.",
    derivacion_humano:
      "üë®‚Äçüíº Te estoy derivando con un representante humano. Espera un momento...",
    servicio_reiniciando: "üîÑ Servicio reinici√°ndose. Vuelve en un momento...", // Nuevo para Heroku
  },

  // Palabras clave y comandos
  comandos: {
    saludo: [
      "hola",
      "hi",
      "hello",
      "buenas",
      "buenos dias",
      "buenas tardes",
      "buenas noches",
      "inicio",
      "start",
    ],
    pedidos: ["mis pedidos", "pedidos", "ordenes", "compras"],
    estado: ["estado", "status", "seguimiento", "tracking"],
    productos: ["productos", "catalogo", "art√≠culos", "items", "que venden"],
    contacto: [
      "contacto",
      "tel√©fono",
      "direcci√≥n",
      "ubicaci√≥n",
      "soporte",
      "ayuda",
    ],
    activos: ["activos", "pendientes", "en proceso", "vigentes"],
    ayuda: ["ayuda", "help", "comandos", "opciones", "\\?"],
    // Comandos espec√≠ficos para debugging en Heroku
    debug: ["debug", "status", "health", "ping"],
  },

  // Emojis y s√≠mbolos utilizados
  emojis: {
    estados: {
      pending: "‚è≥",
      processing: "üîÑ",
      shipped: "üöö",
      delivered: "‚úÖ",
      cancelled: "‚ùå",
      refunded: "üí∏",
    },
    acciones: {
      buscar: "üîç",
      cargar: "‚è≥",
      exito: "‚úÖ",
      error: "‚ùå",
      info: "‚ÑπÔ∏è",
      atencion: "‚ö†Ô∏è",
      dinero: "üí∞",
      productos: "üõçÔ∏è",
      usuario: "üë§",
      fecha: "üìÖ",
      telefono: "üìû",
      email: "üìß",
      direccion: "üìç",
      entrega: "üöö",
      pago: "üí≥",
    },
  },

  // Validaciones
  validaciones: {
    telefono: /^\+?54\d{10}$/,
    email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    numeroPedido: /^\d+$/,
    codigoProducto: /^[A-Za-z0-9\-_]+$/,
  },

  // URLs de webhooks y APIs externas
  apis: {
    mercadopago: {
      accessToken: process.env.MP_ACCESS_TOKEN,
      sandbox: process.env.MP_SANDBOX === "true",
    },
    // Configuraci√≥n de monitoreo para Heroku
    monitoring: {
      healthCheckInterval: 25 * 60 * 1000, // 25 minutos
      keepAliveUrl: process.env.KEEP_ALIVE_URL,
      uptimeRobotUrl: process.env.UPTIME_ROBOT_URL,
    },
  },

  // Configuraci√≥n espec√≠fica de Heroku
  heroku: {
    dynoType: process.env.DYNO || "web",
    release: process.env.HEROKU_RELEASE_VERSION,
    slug: process.env.HEROKU_SLUG_COMMIT,
    appName: process.env.HEROKU_APP_NAME,
    region: process.env.HEROKU_REGION || "us",
    // Configuraci√≥n de logs
    logDrain: process.env.LOG_DRAIN_URL,
    // Configuraci√≥n de memoria
    maxMemory: parseInt(process.env.WEB_MEMORY) || 512,
    // Configuraci√≥n de timeout
    requestTimeout: 30000, // 30 segundos
  },
};

/**
 * Obtener configuraci√≥n de la empresa
 * @returns {Object} Informaci√≥n de la empresa
 */
config.obtenerInfoEmpresa = function () {
  return {
    nombre: this.empresa.nombre,
    contacto: `üìû ${this.empresa.telefono}\nüìß ${this.empresa.email}\nüìç ${this.empresa.direccion}\nüïê ${this.empresa.horario}`,
  };
};

/**
 * Verificar si estamos en horario de atenci√≥n
 * @returns {boolean} True si estamos en horario
 */
config.enHorarioAtencion = function () {
  const ahora = new Date();
  const dia = ahora.toLocaleDateString("es", { weekday: "long" }).toLowerCase();
  const hora = ahora.getHours();

  const configDia = this.horarios.dias[dia];

  if (!configDia || configDia.activo === false) {
    return false;
  }

  return hora >= configDia.inicio && hora < configDia.fin;
};

/**
 * Obtener mensaje de horario
 * @returns {string} Mensaje sobre el horario
 */
config.obtenerMensajeHorario = function () {
  if (this.enHorarioAtencion()) {
    return "‚úÖ Estamos disponibles ahora";
  }

  return this.respuestasAuto.fuera_horario.replace(
    "{horario}",
    this.empresa.horario
  );
};

/**
 * Validar comando
 * @param {string} mensaje - Mensaje del usuario
 * @returns {string|null} Tipo de comando identificado
 */
config.identificarComando = function (mensaje) {
  const textoLimpio = mensaje.toLowerCase().trim();

  for (const [tipo, palabrasClave] of Object.entries(this.comandos)) {
    if (palabrasClave.some((palabra) => textoLimpio.includes(palabra))) {
      return tipo;
    }
  }

  // Verificar si es un n√∫mero de pedido
  if (this.validaciones.numeroPedido.test(textoLimpio)) {
    return "numero_pedido";
  }

  return null;
};

/**
 * Obtener emoji para estado
 * @param {string} estado - Estado del pedido
 * @returns {string} Emoji correspondiente
 */
config.obtenerEmojiEstado = function (estado) {
  return this.emojis.estados[estado] || "üìã";
};

/**
 * Verificar si la app est√° en modo producci√≥n (Heroku)
 * @returns {boolean} True si est√° en producci√≥n
 */
config.esProduccion = function () {
  return process.env.NODE_ENV === "production";
};

/**
 * Obtener informaci√≥n de la instancia de Heroku
 * @returns {Object} Informaci√≥n del dyno de Heroku
 */
config.obtenerInfoHeroku = function () {
  return {
    dyno: this.heroku.dynoType,
    release: this.heroku.release,
    appName: this.heroku.appName,
    region: this.heroku.region,
    isProduction: this.esProduccion(),
  };
};

/**
 * Verificar l√≠mites de recursos para Heroku
 * @returns {Object} Estado de los recursos
 */
config.verificarRecursos = function () {
  const memoryUsage = process.memoryUsage();
  const memoryMB = memoryUsage.heapUsed / 1024 / 1024;

  return {
    memoryUsed: Math.round(memoryMB),
    memoryLimit: this.heroku.maxMemory,
    memoryPercent: Math.round((memoryMB / this.heroku.maxMemory) * 100),
    uptime: process.uptime(),
    isMemoryHigh: memoryMB > this.heroku.maxMemory * 0.8, // Alerta al 80%
  };
};

module.exports = config;
